{% extends "base.html" %}
{% set title = player.name %}
{% block content %}
  <a href="/instructor" class="btn btn-ghost mb-1">← Back to Clients</a>

  <div class="player-header card">
    <div class="player-id">
      <div class="avatar">
        {% if player.avatar_url or player.image_path %}
          <img src="{{ player.avatar_url or player.image_path }}" alt="{{ player.name }}"/>
        {% else %}
          <div class="avatar-placeholder">{{ player.name|initials }}</div>
        {% endif %}
      </div>
      <div>
        <h2 class="player-name">{{ player.name }}</h2>
        <div class="muted">Login Code: {{ player.login_code }}</div>
      </div>
    </div>
    <button class="star" data-player="{{ player.id }}"><span class="star-shape">★</span></button>
  </div>

  <div class="grid two">
    <!-- Left: Chart -->
    <section class="card">
      <h3 class="section-title">Exit Velocity Trend</h3>
      {% if dates and dates|length > 0 %}
        <canvas id="evChart" height="140"></canvas>
      {% else %}
        <div class="muted">No exit velocity data yet.</div>
      {% endif %}
    </section>

    <!-- Right: Add Metric + Latest Metrics -->
    <section class="card">
      <h3 class="section-title">Add Metric</h3>
      <form method="post" action="/metrics/add" class="form">
        <input type="hidden" name="player_id" value="{{ player.id }}"/>

        <label>Metric</label>
        <select name="metric" required>
          <option value="exit_velocity">Exit Velocity</option>
          <option value="launch_angle">Launch Angle</option>
          <option value="spin_rate">Spin Rate</option>
        </select>

        <label>Value</label>
        <input name="value" type="number" step="0.01" placeholder="Enter a number" required />

        <label>Unit</label>
        <input name="unit" list="unitOptions" placeholder="e.g., mph / deg / rpm" />
        <datalist id="unitOptions">
          <option value="mph"></option>
          <option value="deg"></option>
          <option value="rpm"></option>
        </datalist>

        <label>Note (optional)</label>
        <input name="note" placeholder="Context for this measurement" />

        <button class="btn btn-red">Save</button>
      </form>

      <h3 class="section-title mt-2">Updated Metrics</h3>
      <ul class="list mt-1">
        {% for m in latest_metrics or [] %}
          <li>
            <div>
              <strong>{{ m.metric|replace('_',' ')|title }}</strong>:
              {{ (m.value is not none) and ('%.2f'|format(m.value)) or '0.00' }}
              {% if m.unit %} {{ m.unit }}{% endif %}
            </div>
            <div class="muted">
              {{ m.recorded_at|datetimeformat("%Y-%m-%d %H:%M") }}
              {% if m.source %} • {{ m.source }}{% endif %}
            </div>
            {% if m.note %}<div class="muted">“{{ m.note }}”</div>{% endif %}
          </li>
        {% else %}
          <li class="muted">No metrics recorded yet.</li>
        {% endfor %}
      </ul>
    </section>
  </div>

  <div class="grid two">
    <!-- Coach Notes (read-only list) -->
    <section class="card">
      <h3 class="section-title">Coach Notes</h3>
      <ul class="list mt-1">
        {% for n in notes or [] %}
          <li>
            <div class="note-text">{{ n.text }}</div>
            <div class="note-meta">
              {{ n.created_at|datetimeformat("%Y-%m-%d %H:%M") }}
              {% if n.kind %} • {{ n.kind|title }}{% endif %}
            </div>
          </li>
        {% else %}
          <li class="muted">No notes yet.</li>
        {% endfor %}
      </ul>
    </section>

    <!-- Assigned Drills (read-only list) -->
    <section class="card">
      <h3 class="section-title">Assigned Drills</h3>
      <ul class="list mt-1">
        {% for a in assignments or [] %}
          <li>
            <div><strong>{{ a.drill_name or "Drill" }}</strong> — {{ a.status or 'assigned' }}</div>
            {% if a.note %}<div class="muted">“{{ a.note }}”</div>{% endif %}
            <div class="muted">
              Assigned: {{ a.created_at|datetimeformat("%Y-%m-%d") }}
              {% if a.due_date %} • Due: {{ a.due_date|datetimeformat("%Y-%m-%d") }}{% endif %}
            </div>
          </li>
        {% else %}
          <li class="muted">No assigned drills yet.</li>
        {% endfor %}
      </ul>
    </section>
  </div>

  <!-- Scripts -->
  <script>
    // Star toggle
    (function () {
      const starBtn = document.querySelector('.player-header .star');
      if (!starBtn) return;
      starBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const pid = starBtn.dataset.player;
        try {
          const res = await fetch(`/favorite/${pid}`, { method: 'POST' });
          const j = await res.json();
          const fav = (j && (('favorite' in j) ? j.favorite : j.favorited));
          if (j && (j.ok === true || typeof fav === 'boolean')) {
            starBtn.querySelector('.star-shape').classList.toggle('on', !!fav);
          }
        } catch (err) {
          console.error(err);
        }
      });
    })();

    // Exit Velocity Chart (defensive against undefined context)
    (function () {
      const labels = {{ (dates or [])|tojson }};
      const data = {{ (exitv or [])|tojson }};
      if (!Array.isArray(labels) || labels.length === 0) return;

      const ensureChartJs = () => new Promise((resolve) => {
        if (window.Chart) return resolve();
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/chart.js";
        s.onload = resolve;
        document.head.appendChild(s);
      });

      ensureChartJs().then(() => {
        const el = document.getElementById('evChart');
        if (!el) return;
        new Chart(el, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Exit Velocity (mph)',
              data: data,
              fill: false,
              tension: 0.25
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { ticks: { autoSkip: true, maxTicksLimit: 6 } },
              y: { beginAtZero: true }
            },
            plugins: { legend: { display: true } }
          }
        });
      });
    })();
  </script>
{% endblock %}
